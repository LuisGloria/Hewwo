<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bomb Sniffing</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body, html {
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-family: sans-serif;
      background-color: black
    }

    .bar {
      position: fixed;
      left: 0;
      width: 100%;
      background-color: white;
      z-index: 9999; /* big ahh z-index*/
    }

    /* Individual bars */
    .bar-544 { top: 480px; height: 10px; }
    .bar-463 { top: 399px; height: 5px; }
    .bar-394 { top: 330px; height: 1px; }
    .bar-334 { top: 270px; height: 1px; }
    .bar-322 { top: 258px; height: 1px; }
    .bar-264 { top: 200px; height: 1px; }
    .bar-64  { top: 0px;  height: 1px; }
    .bar-36  { top: -29px; height: 2px; } /* 36 - 65 = -29, why did I coment this? I hate math */
    .bar-107 { top: 42px;  height: 3px; }
    .bar-283 { top: 218px; height: 3px; }

    .game-container {
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      position: relative;
    }

    .background-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: url('assets/bg.png');
      background-size: cover;
      background-position: center;
      z-index: 0;
      transition: transform 0.2s ease;
    }

    .foreground-layer {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000; /* bigger ahh z-index */
    }

    .character-wrapper {
      position: relative;
      z-index: 10000;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .character {
      width: 150px;
      height: auto;
      margin-top: 300px;
    }

    .note-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 5000;
      margin-top: 150px;
    }


    .note {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 50px;
      height: auto;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
    }

    .note.left {
      left: 0;
    }

    .note.right {
      right: 0;
    }

    .hit-line {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 4px;
      background-color: red;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9998;
      opacity: 0.5;
    }

    .feedback-layer {
      position: fixed;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
      z-index: 1000000; /* Expand you mind, Omori! */
    }

    .feedback-img {
      position: absolute;
      opacity: 1;
      animation: fadeOut 1s ease-out forwards;
      height: 64px;
      image-rendering: pixelated;
    }

    @keyframes fadeOut {
      0% { opacity: 1; }
      100% { opacity: 0; transform: translateY(-20px); }
    }

    .stats-bar {
      position: absolute;
      bottom: 10px;
      width: 100%;
      text-align: center;
      font-family: monospace;
      font-size: 20px;
      color: white;
      background-color: rgba(0, 0, 0, 0.4);
      padding: 8px 0;
      z-index: 100;
      pointer-events: none;
    }

    @keyframes pulsate-tilt {
      0% {
        transform: scale(1) rotate(0deg);
      }
      50% {
        transform: scale(1.1) rotate(var(--tilt-angle));
      }
      100% {
        transform: scale(1) rotate(0deg);
      }
    }

    .pulsate-tilt {
      animation: pulsate-tilt 0.1s ease-in-out;
    }


  </style>
</head>
<body>

  <div class="bar bar-544"></div>
  <div class="bar bar-463"></div>
  <div class="bar bar-394"></div>
  <div class="bar bar-334"></div>
  <div class="bar bar-322"></div>
  <div class="bar bar-264"></div>
  <div class="bar bar-64"></div>
  <div class="bar bar-36"></div>
  <div class="bar bar-107"></div>
  <div class="bar bar-283"></div>

  <div class="background-layer"></div>
    <div class="foreground-layer">
    <div class="hit-line"></div>
    <div class="note-layer"></div>
    <div class="character-wrapper">
    <div class="feedback-layer"></div>
      <img class="character" src="assets/IDLE.gif" alt="Character Idle">
    </div>
  </div>

  <script>

    const HITBOX_X = window.innerWidth / 2;

    const character = document.querySelector('.character');
    const background = document.querySelector('.background-layer');

    let keyPressed = null;
    let moveAmount = 50;

    let totalNotesAttempted = 0;
    let successfulHits = 0;
    let breaks = 0;
    let combo = 0;
    let maxCombo = 0;
    let weightedHitSum = 0;

    new Audio('music/bomb.mp3').play().catch(err => {
      console.warn('Autoplay failed:', err);
    });

    document.addEventListener('keydown', (e) => {
      if (!window._musicStarted) {
        new Audio('music/song.mp3').play().catch(err => {
          console.warn('Autoplay failed:', err);
        });
        window._musicStarted = true;
      }
      // Handle movement keys first
      if (keyPressed !== e.code) {
        if (e.code === 'ArrowRight') {
          character.src = 'assets/right.gif';
          background.style.transform = `translateX(-${moveAmount}px)`;
          keyPressed = e.code;
          return;  // Exit early since movement handled
        } else if (e.code === 'ArrowLeft') {
          character.src = 'assets/left.gif';
          background.style.transform = `translateX(${moveAmount}px)`;
          keyPressed = e.code;
          return;  // Exit early
        }
      }

      // Handle Space for hitting notes, is probably fucked
      if (e.code === 'Space') {
        const now = performance.now();
        const elapsed = now - startTime;

        for (let i = 0; i < notes.length; i++) {
          const note = notes[i];
          const el = note.element;
          const noteTime = note.type === 'tap' ? note.time : note.start;

          const elX = parseFloat(el.style.left);
          const noteCenter = elX + (el.offsetWidth / 2);

          if (Math.abs(noteCenter - HITBOX_X) <= HIT_WINDOW) {
            note.hit = true;  // mark note as hit before processing
            hitNote(note);
            el.remove();
            notes.splice(i, 1);
            break;
          }
        }
      }
    });

    document.addEventListener('keyup', (e) => {
      if (e.code === 'ArrowRight' || e.code === 'ArrowLeft') {
        character.src = 'assets/IDLE.gif';
        background.style.transform = `translateX(0px)`;
        keyPressed = null;
      }
    });

    function timeStringToMs(timeStr) {
      const [hms, ms] = timeStr.split(',');
      const [hh, mm, ss] = hms.split(':').map(Number);
      const totalMs = ((hh * 3600 + mm * 60 + ss) * 1000) + Number(ms);
      console.log(`Parsing time '${timeStr}' → ${totalMs} ms`);
      return totalMs;
    }


    function parseNoteLine(line) {
      line = line.trim();
      if (!line || line.startsWith('#')) return null;

      const [timePart, lanePart] = line.split('|').map(s => s.trim());
      const lane = lanePart === 'L' ? 'left' : 'right';

      if (timePart.includes('-')) {
        const [startStr, endStr] = timePart.split('-').map(s => s.trim());
        return {
          type: 'hold',
          lane,
          start: timeStringToMs(startStr),
          end: timeStringToMs(endStr)
        };
      } else {
        return {
          type: 'tap',
          lane,
          time: timeStringToMs(timePart)
        };
      }
    }

    const noteFileContent = `
    00:00:02,05 | L
    00:00:02,77 | R
    00:00:03,70 | L
    00:00:04,57 | R
    00:00:05,57 | L
    00:00:06,50 | R
    00:00:07,47 | L
    00:00:08,40 | R
    00:00:09,39 | L
    00:00:10,28 | R
    00:00:11,20 | L
    00:00:12,15 | R
    00:00:13,16 | L
    00:00:14,12 | R
    00:00:15,02 | L
    00:00:15,93 | R
    00:00:16,89 | L
    00:00:17,82 | R
    00:00:18,73 | L
    00:00:19,71 | R
    00:00:20,57 | L
    00:00:21,51 | R
    00:00:22,46 | L
    00:00:23,41 | R
    00:00:24,48 | R
    00:00:25,39 | L
    00:00:26,33 | L
    00:00:27,26 | R
    00:00:28,17 | R
    00:00:29,14 | L
    00:00:30,03 | L
    00:00:30,30 | R
    00:00:30,64 | L
    00:00:31,60 | L
    00:00:32,55 | R
    00:00:33,05 | R
    00:00:33,88 | L
    00:00:34,80 | R
    00:00:35,64 | L
    00:00:36,70 | R
    00:00:37,58 | L
    00:00:38,43 | R
    00:00:39,48 | L
    00:00:40,46 | R
    00:00:41,45 | L
    00:00:42,43 | R
    00:00:43,36 | L
    00:00:44,26 | R
    00:00:45,26 | L
    00:00:46,20 | R
    00:00:47,08 | L
    00:00:48,06 | L
    00:00:48,97 | R
    00:00:49,92 | R
    00:00:50,85 | L
    00:00:51,83 | L
    00:00:52,76 | R
    00:00:53,72 | R
    00:00:54,68 | L
    00:00:55,59 | R
    00:00:56,53 | L
    00:00:57,40 | R
    00:00:58,37 | L
    00:00:59,33 | R
    00:01:00,25 | L
    00:01:01,25 | L
    00:01:02,70 | R
    00:01:04,45 | R
    00:01:05,50 | L
    00:01:06,04 | R
    00:01:06,50 | L
    00:01:06,96 | R
    00:01:07,86 | L
    00:01:08,39 | R
    00:01:08,86 | L
    00:01:09,75 | L
    00:01:10,71 | R
    00:01:11,67 | L
    00:01:12,57 | R
    00:01:13,49 | L
    00:01:14,44 | R
    00:01:15,38 | L
    00:01:16,34 | R
    00:01:17,81 | L
    00:01:19,62 | R
    00:01:20,64 | L
    00:01:21,10 | R
    00:01:21,60 | L
    00:01:22,00 | R
    00:01:22,86 | L
    00:01:23,20 | L
    00:01:23,49 | R
    00:01:24,42 | L
    00:01:25,31 | R
    00:01:26,23 | L
    00:01:27,25 | R
    00:01:28,22 | L
    00:01:29,12 | R
    00:01:30,06 | L
    00:01:30,99 | R
    00:01:31,92 | L
    00:01:32,78 | R
    00:01:33,76 | L
    00:01:34,71 | R
    00:01:35,70 | L
    00:01:36,64 | R
    00:01:37,65 | L
    00:01:38,54 | R
    00:01:39,10 | L
    00:01:39,56 | R
    00:01:40,52 | L
    00:01:41,42 | R
    00:01:42,45 | L
    00:01:43,31 | R
    00:01:44,24 | L
    00:01:45,17 | R
    00:01:45,68 | L
    00:01:46,09 | R
    00:01:46,50 | L
    00:01:47,83 | R
    00:01:48,98 | L
    00:01:49,89 | R
    00:01:50,86 | L
    00:01:51,30 | R
    00:01:51,76 | L
    00:01:52,20 | R
    00:01:52,64 | L
    00:01:54,64 | L
    00:01:55,20 | R
    00:01:55,59 | L
    00:01:56,01 | R
    00:01:58,48 | L
    00:01:59,32 | R
    00:02:00,24 | L
    00:02:01,17 | R
    00:02:01,64 | R
    00:02:02,13 | R
    00:02:03,11 | L
    00:02:04,05 | R
    00:02:04,99 | L
    00:02:05,47 | L
    00:02:05,90 | L
    00:02:06,84 | R
    00:02:07,78 | L
    00:02:08,68 | R
    00:02:09,17 | R
    00:02:09,64 | R
    00:02:10,60 | L
    00:02:11,54 | R
    00:02:12,53 | L
    00:02:13,83 | L
    00:02:14,78 | R
    00:02:15,76 | R
    00:02:16,75 | R
    00:02:17,66 | L
    00:02:18,57 | L
    00:02:19,56 | R
    00:02:20,51 | R
    00:02:21,49 | L
    00:02:22,41 | L
    00:02:23,33 | R
    00:02:24,25 | R
    00:02:25,25 | L
    00:02:26,18 | L
    00:02:27,49 | R
    00:02:28,99 | L
    00:02:29,95 | R
    00:02:30,90 | L
    00:02:31,78 | R
    00:02:32,76 | L
    00:02:33,70 | R
    00:02:34,70 | L
    00:02:35,66 | R
    00:02:36,55 | L
    00:02:37,55 | R
    00:02:38,50 | L
    00:02:39,44 | R
    00:02:40,37 | L
    00:02:41,30 | R
    00:02:42,31 | L
    00:02:43,74 | R
    00:02:45,51 | L
    00:02:48,41 | R
    00:02:50,09 | L
    00:02:55,02 | L
    00:02:55,90 | R
    00:02:56,43 | L
    00:02:56,93 | R
    00:02:57,79 | L
    00:02:58,70 | R
    00:02:59,66 | L
    00:03:00,64 | R
    00:03:01,55 | L
    00:03:02,53 | R
    00:03:03,92 | L
    00:03:04,87 | R
    00:03:05,86 | L
    00:03:06,78 | L
    00:03:07,62 | L
    00:03:08,56 | R
    00:03:09,57 | L
    00:03:10,50 | L
    00:03:11,45 | R
    00:03:12,38 | L
    00:03:13,34 | R
    00:03:14,30 | L
    00:03:15,21 | R
    00:03:16,14 | L
    00:03:17,11 | R
    00:03:18,03 | L
    00:03:19,00 | R
    00:03:19,95 | L
    00:03:20,94 | R
    00:03:21,89 | L
    00:03:22,79 | R
    00:03:23,79 | L
    00:03:24,68 | R
    00:03:25,62 | L
    00:03:26,59 | R
    00:03:27,53 | L
    00:03:28,89 | L
    00:03:29,44 | L
    00:03:30,50 | R
    00:03:31,36 | R
    00:03:33,46 | L
    00:03:34,75 | R
    00:03:36,07 | L
    00:03:37,03 | R
    00:03:40,28 | L
    00:03:40,74 | L
    00:03:41,20 | L
    00:03:41,62 | L
    00:03:42,54 | R
    00:03:43,05 | R
    00:03:43,51 | R
    00:03:44,53 | L
    00:03:44,98 | L
    00:03:45,38 | L
    00:03:47,37 | R
    00:03:49,61 | L
    00:03:50,16 | R
    00:03:50,62 | L
    00:03:51,16 | R
    00:03:51,64 | L
    00:03:52,04 | L
    00:03:52,55 | R
    00:03:53,01 | R
    00:03:53,42 | L
    00:03:53,97 | L
    00:03:55,37 | R
    00:03:55,93 | L
    00:03:56,35 | R
    00:03:56,79 | L
    00:03:57,26 | R
    00:03:58,23 | L
    00:03:58,95 | L
    00:03:59,92 | R
    00:04:00,99 | L
    00:04:01,51 | R
    00:04:01,99 | L
    00:04:02,46 | R
    00:04:03,45 | L
    00:04:04,30 | L
    00:04:05,24 | R
    00:04:06,22 | R
    00:04:07,15 | R
    00:04:08,13 | L
    00:04:09,05 | L
    00:04:09,90 | R
    00:04:10,75 | R
    00:04:11,81 | R
    00:04:12,81 | R
    00:04:13,97 | L
    00:04:15,02 | L
    00:04:16,03 | L
    00:04:16,55 | R
    00:04:17,04 | L
    00:04:17,49 | L
    00:04:18,43 | L
    00:04:18,80 | R
    00:04:19,25 | R
    `;

    /* "00:00:04,91 - 00:00:05,29 | R"  -- Do not use long notes, they're fucked*/

    const noteLines = noteFileContent.split('\n');
    const notes = [];

    const noteLayer = document.querySelector('.note-layer');
    const startTime = performance.now();
    const hitY = 400; // Y-position where the character stands, I should change this maybe
    const noteScrollSpeed = 0.5; // Pixels per ms

    function renderNoteElement(note) {
      const NOTE_HEIGHT = 50;

      if (note.type === 'tap') {
        const el = document.createElement('img');
        el.classList.add('note', note.lane);
        el.src = 'assets/hp1.png';
        el.style.height = `${NOTE_HEIGHT}px`;
        el.dataset.time = note.time;
        el.dataset.type = note.type;
        note.element = el;
        noteLayer.appendChild(el);
      } else if (note.type === 'hold') {
        const container = document.createElement('div');
        container.classList.add('note', note.lane);
        container.dataset.time = note.start;
        container.dataset.type = note.type;
        container.style.display = 'flex';
        container.style.alignItems = 'center';
        container.style.position = 'absolute';
        container.style.top = '50%';
        container.style.transform = 'translateY(-50%)';

        const startImg = document.createElement('img');
        startImg.src = 'assets/hp1.png';
        startImg.style.height = `${NOTE_HEIGHT}px`;
        startImg.style.flexShrink = '0';

        const middleImg = document.createElement('img');
        middleImg.src = 'assets/hp2.png';
        middleImg.style.height = `${NOTE_HEIGHT}px`;
        //prevent clipping the first pixel
        middleImg.style.width = `${(note.end - note.start) * noteScrollSpeed + 1}px`;
        middleImg.style.flexShrink = '0';
        middleImg.style.objectFit = 'fill'; // Optional: prevent distortion, this might've not worked.

        const endImg = document.createElement('img');
        endImg.src = 'assets/hp3.png';
        endImg.style.height = `${NOTE_HEIGHT}px`;
        endImg.style.flexShrink = '0';

        // Flip end cap if note is on the right
        if (note.lane === 'right') {
          endImg.style.transform = 'scaleX(-1)';
        }

        container.appendChild(startImg);
        container.appendChild(middleImg);
        container.appendChild(endImg);

        note.element = container;
        noteLayer.appendChild(container);
      }
    }



    for (const line of noteLines) {
      const note = parseNoteLine(line);
      if (note) notes.push(note);
    }

    notes.forEach(renderNoteElement);

    console.log('Parsed notes:', notes);

    const missThreshold = 150;

    function updateNotes() {
      const now = performance.now();
      const elapsed = now - startTime;
      const hitX = window.innerWidth / 2;

      for (const note of notes) {
        if (note.hit) continue; // Skip already hit notes, lol

        const el = note.element;
        const noteTime = note.type === 'tap' ? note.time : note.start;
        const timeUntilHit = noteTime - elapsed;
        const distance = timeUntilHit * noteScrollSpeed;

        // Move the note
        if (note.lane === 'left') {
          el.style.left = `${Math.min(hitX, Math.max(0, hitX - distance))}px`;
        } else if (note.lane === 'right') {
          el.style.left = `${Math.max(hitX, Math.min(window.innerWidth, hitX + distance))}px`;
        }

        // Check for misses cuz' you bad on rhythm gamez
        if (timeUntilHit < -missThreshold && !note.hit) {
          note.hit = true;
          el.remove();
          combo = 0;
          breaks++;
          totalNotesAttempted++;
          updateStatsBar();
          console.log('Missed note at', noteTime);
        }
      }

      requestAnimationFrame(updateNotes);
    }

    updateNotes();

    const HIT_WINDOW = 200;

    document.addEventListener('keydown', (e) => {
      if (e.code === 'Space') {
        const now = performance.now();
        const elapsed = now - startTime;

        for (let i = 0; i < notes.length; i++) {
          const note = notes[i];
          const el = note.element;
          const noteTime = note.type === 'tap' ? note.time : note.start;

          const elX = parseFloat(el.style.left);
          const noteCenter = elX + (el.offsetWidth / 2);

          if (Math.abs(noteCenter - HITBOX_X) <= HIT_WINDOW) {
            hitNote(note); // THIS triggers judgment and the feedback...I hope
            el.remove();
            notes.splice(i, 1);
            break;
          }
        }
      }
    });

    function hitNote(note) {
      const now = performance.now();
      const diff = Math.abs(note.time - (now - startTime));

      let feedback;
      let weight = 0;

      if (diff < 50) {
        feedback = "perfect";
        weight = 1.0;
        combo++;
        successfulHits++;
      } else if (diff < 100) {
        feedback = "nice";
        weight = 0.75;
        combo++;
        successfulHits++;
      } else if (diff < 200) {
        feedback = "ass";
        weight = 0.5;
        combo++;
        successfulHits++;
      } else {
        feedback = "miss";
        weight = 0.0;
        combo = 0;
        breaks++;
      }

      totalNotesAttempted++;
      weightedHitSum += weight;
      maxCombo = Math.max(maxCombo, combo);

      updateStatsBar();
      showFeedback(feedback);

      // Pulsate + tilt effect:
      const statsBar = document.querySelector('.stats-bar');

      // Pick a random tilt angle ±25deg
      const angle = (Math.random() < 0.5 ? -1 : 1) * 1;
      statsBar.style.setProperty('--tilt-angle', `${angle}deg`);

      // Restart animation
      statsBar.classList.remove('pulsate-tilt');
      void statsBar.offsetWidth; // trigger reflow
      statsBar.classList.add('pulsate-tilt');
    }


    function showFeedback(type) {
      const feedback = document.createElement('img');
      feedback.src = `assets/${type}.png`;
      feedback.classList.add('feedback-img');

      const character = document.querySelector('.character');
      const wrapper = document.querySelector('.character-wrapper');
      const charRect = character.getBoundingClientRect();
      const wrapperRect = wrapper.getBoundingClientRect();

      // Position relative to wrapper
      const offsetX = charRect.left - wrapperRect.left + (charRect.width / 2 + 600);
      const offsetY = charRect.top - wrapperRect.top + (charRect.height / 2 - 100);

      feedback.style.left = `${offsetX}px`;
      feedback.style.top = `${offsetY}px`;
      feedback.style.transform = 'translate(-50%, -50%)'; // Centered both axes

      const layer = document.querySelector('.feedback-layer');
      layer.appendChild(feedback);

      setTimeout(() => feedback.remove(), 1000);
    }

    function updateStatsBar() {
      const acc = totalNotesAttempted > 0 ? (weightedHitSum / totalNotesAttempted) * 100 : 0;
      const accString = acc.toFixed(2).replace('.', ',');

      let rating;
      if (acc === 100) rating = "P (Perfect!!)";
      else if (acc >= 95) rating = "S+ (Hell yeah!!)";
      else if (acc >= 90) rating = "S (Hell yea!)";
      else if (acc >= 85) rating = "A (Amazing!)";
      else if (acc >= 80) rating = "A- (Amazing!)";
      else if (acc >= 75) rating = "B (Good.)";
      else if (acc >= 70) rating = "B- (Good.)";
      else if (acc >= 65) rating = "C (Good enough.)";
      else if (acc >= 60) rating = "C- (Good enough.)";
      else if (acc >= 50) rating = "D (Oh boy...)";
      else if (acc >= 45) rating = "D- (Please leave...)";
      else if (acc >= 40) rating = "F (Exit's right there)";
      else rating = "F- (My ears are bleeding)";

      document.querySelector('.stats-bar').textContent =
        `BIGGEST COMBO: ${maxCombo.toString().padStart(3, '0')} | ` +
        `COMBO BREAKS: ${breaks.toString().padStart(2, '0')} | ` +
        `ACC: ${accString}% | ` +
        `RATING: ${rating}`;
    }

    function updateAccuracy() {
      const totalAttempts = totalHits + totalMisses;
      if (totalAttempts === 0) return 0;

      const acc = (totalHits / totalAttempts) * 100;
      return acc.toFixed(2);
    }

  </script>

</body>

  <div class="stats-bar">
    BIGGEST COMBO: ??? | COMBO BREAKS: ??? | ACC: ??,??% | RATING: ??
  </div>
</html>
